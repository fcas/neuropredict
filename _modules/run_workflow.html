
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>run_workflow &#8212; neuropredict 0.6 documentation</title>
    <link rel="stylesheet" href="../_static/pd.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <script type="text/javascript" src="../_static/pd.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

  </head><body>
    <div id="header">
        <h1>neuropredict 0.6 documentation</h1>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
        <ul>
            <li class="nav-item nav-item-0"><a href="../index.html">neuropredict 0.6 documentation</a> &#187;
            </li>
                <li class="nav-item nav-item-1"><a href="index.html"
                        accesskey="U">Module code</a> &#187;</li>
        </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
<h1>Source code for run_workflow</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">neuropredict : easy and comprehensive predictive analysis.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>

<span class="kn">from</span> <span class="nn">neuropredict.base</span> <span class="k">import</span> <span class="n">organize_inputs</span><span class="p">,</span> <span class="n">MissingDataException</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;cli&#39;</span><span class="p">,</span> <span class="s1">&#39;get_parser&#39;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="k">import</span> <span class="n">version_info</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">pjoin</span><span class="p">,</span> <span class="n">exists</span> <span class="k">as</span> <span class="n">pexists</span><span class="p">,</span> <span class="n">abspath</span><span class="p">,</span> <span class="n">realpath</span><span class="p">,</span> <span class="n">basename</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pyradigm.utils</span> <span class="k">import</span> <span class="n">load_dataset</span>

<span class="k">if</span> <span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="c1"># the order of import is very important to avoid circular imports</span>
    <span class="kn">from</span> <span class="nn">neuropredict</span> <span class="k">import</span> <span class="n">__version__</span>
    <span class="kn">from</span> <span class="nn">neuropredict</span> <span class="k">import</span> <span class="n">config_neuropredict</span> <span class="k">as</span> <span class="n">cfg</span>
    <span class="kn">from</span> <span class="nn">neuropredict</span> <span class="k">import</span> <span class="n">rhst</span><span class="p">,</span> <span class="n">visualize</span>
    <span class="kn">from</span> <span class="nn">neuropredict.freesurfer</span> <span class="k">import</span> <span class="p">(</span><span class="n">aseg_stats_subcortical</span><span class="p">,</span>
                                         <span class="n">aseg_stats_whole_brain</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">neuropredict.io</span> <span class="k">import</span> <span class="p">(</span><span class="n">get_metadata</span><span class="p">,</span> <span class="n">get_features</span><span class="p">,</span>
                                 <span class="n">get_metadata_in_pyradigm</span><span class="p">,</span>
                                 <span class="n">get_data_matrix</span><span class="p">,</span> <span class="n">get_dir_of_dirs</span><span class="p">,</span> <span class="n">get_pyradigm</span><span class="p">,</span>
                                 <span class="n">get_arff</span><span class="p">,</span>
                                 <span class="n">saved_dataset_matches</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">neuropredict.utils</span> <span class="k">import</span> <span class="p">(</span><span class="n">uniq_combined_name</span><span class="p">,</span>
                                    <span class="n">check_num_procs</span><span class="p">,</span>
                                    <span class="n">sub_group_identifier</span><span class="p">,</span> <span class="n">save_options</span><span class="p">,</span> <span class="n">load_options</span><span class="p">,</span>
                                    <span class="n">validate_feature_selection_size</span><span class="p">,</span>
                                    <span class="n">validate_impute_strategy</span><span class="p">,</span>
                                    <span class="n">make_dataset_filename</span><span class="p">,</span> <span class="n">not_unspecified</span><span class="p">,</span>
                                    <span class="n">check_classifier</span><span class="p">,</span> <span class="n">print_options</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;neuropredict requires Python 3+.&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_parser_classify</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">neuropredict.base</span> <span class="k">import</span> <span class="n">get_parser_base</span>

    <span class="n">parser</span><span class="p">,</span> <span class="n">user_defined</span><span class="p">,</span> <span class="n">cv_args_group</span><span class="p">,</span> <span class="n">pipeline_group</span><span class="p">,</span> <span class="n">vis_args</span><span class="p">,</span> <span class="n">comp_args</span>\
        <span class="o">=</span> <span class="n">get_parser_base</span><span class="p">()</span>

    <span class="n">help_text_fs_dir</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Absolute path to ``SUBJECTS_DIR`` containing the finished runs of </span>
<span class="s2">    Freesurfer parcellation. Each subject will be queried after its ID in the </span>
<span class="s2">    metadata file. E.g. ``--fs_subject_dir /project/freesurfer_v5.3``</span>
<span class="s2">    </span><span class="se">\n</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> &quot;&quot;&quot;</span><span class="p">)</span>

    <span class="n">help_text_arff_paths</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    List of paths to files saved in Weka&#39;s ARFF dataset format.</span>

<span class="s2">    Note: </span>
<span class="s2">     - this format does NOT allow IDs for each subject.</span>
<span class="s2">     - given feature values are saved in text format, this can lead to large files </span>
<span class="s2">     with high-dimensional data, </span>
<span class="s2">        compared to numpy arrays saved to disk in binary format.</span>

<span class="s2">    More info: https://www.cs.waikato.ac.nz/ml/weka/arff.html</span>
<span class="s2">    </span><span class="se">\n</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> &quot;&quot;&quot;</span><span class="p">)</span>

    <span class="n">help_text_positive_class</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    Name of the positive class (e.g. Alzheimers, MCI etc) to be used in </span>
<span class="s2">    calculation of area under the ROC curve. This is applicable only for binary </span>
<span class="s2">    classification experiments.</span>

<span class="s2">    Default: class appearing last in order specified in metadata file.</span>
<span class="s2">    </span><span class="se">\n</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> &quot;&quot;&quot;</span><span class="p">)</span>

    <span class="n">help_text_sub_groups</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    This option allows the user to study different combinations of classes in a </span>
<span class="s2">    multi-class (N&gt;2) dataset.</span>

<span class="s2">    For example, in a dataset with 3 classes CN, FTD and AD, two studies of </span>
<span class="s2">    pair-wise combinations can be studied separately with the following flag </span>
<span class="s2">    ``--sub_groups CN,FTD CN,AD``. This allows the user to focus on few </span>
<span class="s2">    interesting subgroups depending on their dataset/goal.</span>

<span class="s2">    Format: Different subgroups must be separated by space, and each sub-group </span>
<span class="s2">    must be a comma-separated list of class names defined in the meta data file. </span>
<span class="s2">    Hence it is strongly recommended to use class names without any spaces, </span>
<span class="s2">    commas, hyphens and special characters, and ideally just alphanumeric </span>
<span class="s2">    characters separated by underscores.</span>

<span class="s2">    Any number of subgroups can be specified, but each subgroup must have atleast </span>
<span class="s2">    two distinct classes.</span>

<span class="s2">    Default: ``&#39;all&#39;``, leading to inclusion of all available classes in a </span>
<span class="s2">    all-vs-all multi-class setting.</span>
<span class="s2">    </span><span class="se">\n</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> &quot;&quot;&quot;</span><span class="p">)</span>


    <span class="n">help_classifier</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">    String specifying one of the implemented classifiers. </span>
<span class="s2">    (Classifiers are carefully chosen to allow for the comprehensive report </span>
<span class="s2">    provided by neuropredict).</span>

<span class="s2">    Default: &#39;RandomForestClassifier&#39;</span>

<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;--fs_subject_dir&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;fs_subject_dir&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">help_text_fs_dir</span><span class="p">)</span>

    <span class="n">user_defined</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-a&quot;</span><span class="p">,</span> <span class="s2">&quot;--arff_paths&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                              <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;arff_paths&quot;</span><span class="p">,</span>
                              <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span>
                              <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">help</span><span class="o">=</span><span class="n">help_text_arff_paths</span><span class="p">)</span>

    <span class="n">cv_args_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="s2">&quot;--positive_class&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                               <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;positive_class&quot;</span><span class="p">,</span>
                               <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="n">help_text_positive_class</span><span class="p">)</span>

    <span class="n">cv_args_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-sg&quot;</span><span class="p">,</span> <span class="s2">&quot;--sub_groups&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                               <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;sub_groups&quot;</span><span class="p">,</span>
                               <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
                               <span class="n">default</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="n">help_text_sub_groups</span><span class="p">)</span>

    <span class="n">pipeline_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-e&quot;</span><span class="p">,</span> <span class="s2">&quot;--classifier&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
                                <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;classifier&quot;</span><span class="p">,</span>
                                <span class="n">default</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">default_classifier</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">help_classifier</span><span class="p">,</span>
                                <span class="n">choices</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">classifier_choices</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parser</span>


<span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Parser/validator for the cmd line args.&quot;&quot;&quot;</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">get_parser_classify</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too few arguments!&#39;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># parsing</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user_args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># only if no features were specified to be assessed</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">not_unspecified</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">user_args</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
               <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;user_feature_paths&#39;</span><span class="p">,</span> <span class="s1">&#39;data_matrix_paths&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;pyradigm_paths&#39;</span><span class="p">,</span> <span class="s1">&#39;arff_paths&#39;</span><span class="p">)):</span>

            <span class="k">if</span> <span class="n">not_unspecified</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">print_opt_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="n">user_args</span><span class="o">.</span><span class="n">print_opt_dir</span><span class="p">:</span>
                <span class="n">run_dir</span> <span class="o">=</span> <span class="n">realpath</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">print_opt_dir</span><span class="p">)</span>
                <span class="n">print_options</span><span class="p">(</span><span class="n">run_dir</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">not_unspecified</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">make_vis</span><span class="p">):</span>
                <span class="n">out_dir</span> <span class="o">=</span> <span class="n">realpath</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">make_vis</span><span class="p">)</span>
                <span class="n">res_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">file_name_results</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pexists</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pexists</span><span class="p">(</span><span class="n">res_path</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">not_unspecified</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">make_vis</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Saving the visualizations to </span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_dir</span><span class="p">))</span>
                        <span class="n">make_visualizations</span><span class="p">(</span><span class="n">res_path</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Given folder does not exist, &#39;</span>
                                     <span class="s1">&#39;or has no results file!&#39;</span><span class="p">)</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">user_feature_paths</span><span class="p">,</span> <span class="n">user_feature_type</span><span class="p">,</span> <span class="n">fs_subject_dir</span><span class="p">,</span> <span class="n">meta_data_path</span><span class="p">,</span> \
        <span class="n">meta_data_format</span> <span class="o">=</span> <span class="n">organize_inputs</span><span class="p">(</span><span class="n">user_args</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">meta_data_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user_args</span><span class="o">.</span><span class="n">meta_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">meta_file</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">meta_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pexists</span><span class="p">(</span><span class="n">meta_file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Meta data file doesn&#39;t exist.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Metadata file must be provided &#39;</span>
                             <span class="s1">&#39;when not using pyradigm/ARFF inputs.&#39;</span><span class="p">)</span>

        <span class="n">sample_ids</span><span class="p">,</span> <span class="n">classes</span> <span class="o">=</span> <span class="n">get_metadata</span><span class="p">(</span><span class="n">meta_file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using meta data from:</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">meta_data_path</span><span class="p">))</span>
        <span class="n">sample_ids</span><span class="p">,</span> <span class="n">classes</span> <span class="o">=</span> <span class="n">get_metadata_in_pyradigm</span><span class="p">(</span><span class="n">meta_data_path</span><span class="p">,</span>
                                                       <span class="n">meta_data_format</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">user_args</span><span class="o">.</span><span class="n">out_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">realpath</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">out_dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()),</span> <span class="n">cfg</span><span class="o">.</span><span class="n">output_dir_default</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Output folder could not be created.&#39;</span><span class="p">)</span>

    <span class="n">train_perc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">train_perc</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span> <span class="mf">0.01</span> <span class="o">&lt;=</span> <span class="n">train_perc</span> <span class="o">&lt;=</span> <span class="mf">0.99</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Training percentage </span><span class="si">{}</span><span class="s2"> out of bounds &quot;</span>
                         <span class="s2">&quot;- must be &gt;= 0.01 and &lt;= 0.99&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">train_perc</span><span class="p">))</span>

    <span class="n">num_rep_cv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">num_rep_cv</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_rep_cv</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Atleast 10 repetitions of CV is recommened.&quot;</span><span class="p">)</span>

    <span class="n">num_procs</span> <span class="o">=</span> <span class="n">check_num_procs</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">num_procs</span><span class="p">)</span>

    <span class="n">class_set</span><span class="p">,</span> <span class="n">subgroups</span><span class="p">,</span> <span class="n">positive_class</span> <span class="o">=</span> <span class="n">validate_class_set</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span>
                                                              <span class="n">user_args</span><span class="o">.</span><span class="n">sub_groups</span><span class="p">,</span>
                                                              <span class="n">user_args</span><span class="o">.</span><span class="n">positive_class</span><span class="p">)</span>

    <span class="n">feature_selection_size</span> <span class="o">=</span> <span class="n">validate_feature_selection_size</span><span class="p">(</span>
            <span class="n">user_args</span><span class="o">.</span><span class="n">reduced_dim_size</span><span class="p">)</span>

    <span class="n">impute_strategy</span> <span class="o">=</span> <span class="n">validate_impute_strategy</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">impute_strategy</span><span class="p">)</span>

    <span class="n">grid_search_level</span> <span class="o">=</span> <span class="n">user_args</span><span class="o">.</span><span class="n">gs_level</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">grid_search_level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">GRIDSEARCH_LEVELS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unrecognized level of grid search. Valid choices: </span><span class="si">{}</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">GRIDSEARCH_LEVELS</span><span class="p">))</span>

    <span class="n">classifier</span> <span class="o">=</span> <span class="n">check_classifier</span><span class="p">(</span><span class="n">user_args</span><span class="o">.</span><span class="n">classifier</span><span class="p">)</span>
    <span class="n">dim_red_method</span> <span class="o">=</span> <span class="n">user_args</span><span class="o">.</span><span class="n">dim_red_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># saving the validated and expanded values to disk for later use.</span>
    <span class="n">options_to_save</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_ids</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">user_feature_paths</span><span class="p">,</span>
                       <span class="n">user_feature_type</span><span class="p">,</span> <span class="n">fs_subject_dir</span><span class="p">,</span> <span class="n">train_perc</span><span class="p">,</span> <span class="n">num_rep_cv</span><span class="p">,</span>
                       <span class="n">positive_class</span><span class="p">,</span> <span class="n">subgroups</span><span class="p">,</span> <span class="n">feature_selection_size</span><span class="p">,</span> <span class="n">num_procs</span><span class="p">,</span>
                       <span class="n">grid_search_level</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">dim_red_method</span><span class="p">]</span>
    <span class="n">options_path</span> <span class="o">=</span> <span class="n">save_options</span><span class="p">(</span><span class="n">options_to_save</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sample_ids</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">options_path</span><span class="p">,</span> \
           <span class="n">user_feature_paths</span><span class="p">,</span> <span class="n">user_feature_type</span><span class="p">,</span> <span class="n">fs_subject_dir</span><span class="p">,</span> \
           <span class="n">train_perc</span><span class="p">,</span> <span class="n">num_rep_cv</span><span class="p">,</span> \
           <span class="n">positive_class</span><span class="p">,</span> <span class="n">subgroups</span><span class="p">,</span> \
           <span class="n">feature_selection_size</span><span class="p">,</span> <span class="n">impute_strategy</span><span class="p">,</span> <span class="n">num_procs</span><span class="p">,</span> \
           <span class="n">grid_search_level</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">dim_red_method</span>


<span class="k">def</span> <span class="nf">make_visualizations</span><span class="p">(</span><span class="n">results_file_path</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">options_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Produces the performance visualizations/comparison plots from the</span>
<span class="sd">    cross-validation results.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    results_file_path : str</span>
<span class="sd">        Path to file containing results produced by `rhst`</span>

<span class="sd">    out_dir : str</span>
<span class="sd">        Path to a folder to store results.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">results_dict</span> <span class="o">=</span> <span class="n">rhst</span><span class="o">.</span><span class="n">load_results_dict</span><span class="p">(</span><span class="n">results_file_path</span><span class="p">)</span>

    <span class="c1"># using shorter names for readability</span>
    <span class="n">accuracy_balanced</span>       <span class="o">=</span> <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;accuracy_balanced&#39;</span><span class="p">]</span>
    <span class="n">method_names</span>            <span class="o">=</span> <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;method_names&#39;</span><span class="p">]</span>
    <span class="n">num_classes</span>             <span class="o">=</span> <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;num_classes&#39;</span><span class="p">]</span>
    <span class="n">class_sizes</span>             <span class="o">=</span> <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;target_sizes&#39;</span><span class="p">]</span>
    <span class="n">confusion_matrix</span>        <span class="o">=</span> <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;confusion_matrix&#39;</span><span class="p">]</span>
    <span class="n">class_order</span>             <span class="o">=</span> <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;class_set&#39;</span><span class="p">]</span>
    <span class="n">feature_importances_rf</span>  <span class="o">=</span> <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;feature_importances_rf&#39;</span><span class="p">]</span>
    <span class="n">feature_names</span>           <span class="o">=</span> <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;feature_names&#39;</span><span class="p">]</span>
    <span class="n">num_times_misclfd</span>       <span class="o">=</span> <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;num_times_misclfd&#39;</span><span class="p">]</span>
    <span class="n">num_times_tested</span>        <span class="o">=</span> <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;num_times_tested&#39;</span><span class="p">]</span>

    <span class="n">num_methods</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">method_names</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">method_names</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">num_methods</span><span class="p">:</span>
        <span class="n">method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;m</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span><span class="n">mn</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">mn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">method_names</span><span class="p">)]</span>

    <span class="n">feature_importances_available</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">options_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user_options</span> <span class="o">=</span> <span class="n">load_options</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">options_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_options</span><span class="p">[</span><span class="s1">&#39;classifier_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> \
                <span class="n">cfg</span><span class="o">.</span><span class="n">clfs_with_feature_importance</span><span class="p">:</span>
            <span class="n">feature_importances_available</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># check if the all values are NaN</span>
        <span class="n">unusable</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">method_fi</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
                     <span class="k">for</span> <span class="n">method_fi</span> <span class="ow">in</span> <span class="n">feature_importances_rf</span> <span class="p">]</span>
        <span class="n">feature_importances_available</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">unusable</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>

        <span class="n">balacc_fig_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;balanced_accuracy&#39;</span><span class="p">)</span>
        <span class="n">visualize</span><span class="o">.</span><span class="n">metric_distribution</span><span class="p">(</span><span class="n">accuracy_balanced</span><span class="p">,</span> <span class="n">method_names</span><span class="p">,</span>
                                      <span class="n">balacc_fig_path</span><span class="p">,</span> <span class="n">class_sizes</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span>
                                      <span class="s2">&quot;Balanced Accuracy&quot;</span><span class="p">)</span>

        <span class="n">confmat_fig_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;confusion_matrix&#39;</span><span class="p">)</span>
        <span class="n">visualize</span><span class="o">.</span><span class="n">confusion_matrices</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">class_order</span><span class="p">,</span> <span class="n">method_names</span><span class="p">,</span>
                                     <span class="n">confmat_fig_path</span><span class="p">)</span>

        <span class="n">cmp_misclf_fig_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;compare_misclf_rates&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_classes</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">visualize</span><span class="o">.</span><span class="n">compare_misclf_pairwise</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">class_order</span><span class="p">,</span>
                                              <span class="n">method_names</span><span class="p">,</span> <span class="n">cmp_misclf_fig_path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">num_classes</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">visualize</span><span class="o">.</span><span class="n">compare_misclf_pairwise_parallel_coord_plot</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">,</span>
                                                                  <span class="n">class_order</span><span class="p">,</span>
                                                                  <span class="n">method_names</span><span class="p">,</span>
                                                                  <span class="n">cmp_misclf_fig_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">feature_importances_available</span><span class="p">:</span>
            <span class="n">featimp_fig_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;feature_importance&#39;</span><span class="p">)</span>
            <span class="n">visualize</span><span class="o">.</span><span class="n">feature_importance_map</span><span class="p">(</span><span class="n">feature_importances_rf</span><span class="p">,</span> <span class="n">method_names</span><span class="p">,</span>
                                             <span class="n">featimp_fig_path</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Current predictive model, and/or dimensionality reduction&#39;</span>
                  <span class="s1">&#39; method, does not provide (or allow for computing) feature&#39;</span>
                  <span class="s1">&#39; importance values. Skipping them.&#39;</span><span class="p">)</span>

        <span class="n">misclf_out_path</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;misclassified_subjects&#39;</span><span class="p">)</span>
        <span class="n">visualize</span><span class="o">.</span><span class="n">freq_hist_misclassifications</span><span class="p">(</span><span class="n">num_times_misclfd</span><span class="p">,</span> <span class="n">num_times_tested</span><span class="p">,</span>
                                               <span class="n">method_names</span><span class="p">,</span> <span class="n">misclf_out_path</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Error generating the visualizations! Skipping ..&#39;</span><span class="p">)</span>

    <span class="c1"># cleaning up</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

    <span class="k">return</span>


<span class="k">def</span> <span class="nf">validate_class_set</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">subgroups</span><span class="p">,</span> <span class="n">positive_class</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="s2">&quot;Ensures class names are valid and sub-groups exist.&quot;</span>

    <span class="n">class_set</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">classes</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="n">sub_group_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">subgroups</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subgroups</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">subgroups</span> <span class="o">=</span> <span class="p">[</span> <span class="n">subgroups</span><span class="p">,</span> <span class="p">]</span>

        <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">subgroups</span><span class="p">:</span>
            <span class="n">cls_list</span> <span class="o">=</span> <span class="n">comb</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="c1"># ensuring each subgroup has atleast two classes</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cls_list</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Subgroup </span><span class="si">{}</span><span class="s1"> does not contain 2 unique classes! &#39;</span>
                                 <span class="s1">&#39;Each subgroup must contain atleast two classes &#39;</span>
                                 <span class="s1">&#39;for classification experiments.&#39;</span>
                                 <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comb</span><span class="p">))</span>

            <span class="c1"># verify each of them were defined in meta</span>
            <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">cls_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_set</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Class </span><span class="si">{}</span><span class="s2"> in combination </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                     <span class="s2">&quot;does not exist in meta data.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">comb</span><span class="p">))</span>

            <span class="n">sub_group_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cls_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># using all classes</span>
        <span class="n">sub_group_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_set</span><span class="p">)</span>

    <span class="c1"># the following loop is required to preserve original order</span>
    <span class="c1"># this does not: class_order_in_meta = list(set(classes.values()))</span>
    <span class="n">class_order_in_meta</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">class_set</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_order_in_meta</span><span class="p">:</span>
            <span class="n">class_order_in_meta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_order_in_meta</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_classes</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Atleast two classes are required for predictive analysis! &quot;</span>
                         <span class="s2">&quot;Only one given (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">classes</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>

    <span class="k">if</span> <span class="n">num_classes</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">not_unspecified</span><span class="p">(</span><span class="n">positive_class</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">positive_class</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_order_in_meta</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Positive class specified does not exist in meta &#39;</span>
                                 <span class="s1">&#39;data.</span><span class="se">\n</span><span class="s1"> Choose one of </span><span class="si">{}</span><span class="s1">&#39;</span>
                                 <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">class_order_in_meta</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Positive class specified for AUC calculation: </span><span class="si">{}</span><span class="s1">&#39;</span>
                  <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">positive_class</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">positive_class</span> <span class="o">=</span> <span class="n">class_order_in_meta</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Positive class inferred for AUC calculation: </span><span class="si">{}</span><span class="s1">&#39;</span>
                  <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">positive_class</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">class_set</span><span class="p">,</span> <span class="n">sub_group_list</span><span class="p">,</span> <span class="n">positive_class</span>


<span class="k">def</span> <span class="nf">import_datasets</span><span class="p">(</span><span class="n">method_list</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">subjects</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span>
                    <span class="n">feature_path</span><span class="p">,</span> <span class="n">feature_type</span><span class="o">=</span><span class="s1">&#39;dir_of_dirs&#39;</span><span class="p">,</span>
                    <span class="n">user_impute_strategy</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">default_imputation_strategy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Imports all the specified feature sets and organizes them into datasets.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    method_list : list of callables</span>
<span class="sd">        Set of predefined methods returning a vector of features f</span>
<span class="sd">        or a given sample id and location</span>

<span class="sd">    out_dir : str</span>
<span class="sd">        Path to the output folder</span>

<span class="sd">    subjects : list of str</span>
<span class="sd">        List of sample ids</span>

<span class="sd">    classes : dict</span>
<span class="sd">        Dict identifying the class for each sample id in the dataset.</span>

<span class="sd">    feature_path : list of str</span>
<span class="sd">        List of paths to the root folder containing features (pre- or user-defined).</span>
<span class="sd">        Must be of same length as method_list</span>

<span class="sd">    feature_type : str</span>
<span class="sd">        a string identifying the structure of feature set.</span>
<span class="sd">        Choices = (&#39;dir_of_dirs&#39;, &#39;data_matrix&#39;)</span>

<span class="sd">    user_impute_strategy : str</span>
<span class="sd">        Strategy to handle the missing data:</span>
<span class="sd">        whether to raise an error if data is missing,</span>
<span class="sd">        or to impute them using the method chosen here.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    method_names : list of str</span>
<span class="sd">        List of method names used for annotation</span>

<span class="sd">    dataset_paths_file : str</span>
<span class="sd">        Path to the file containing paths to imported feature sets</span>

<span class="sd">    missing_data_flag : list</span>
<span class="sd">        List of boolean flags</span>
<span class="sd">        indicating whether data is missing in each of the input datasets.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">clean_str</span><span class="p">(</span><span class="n">string</span><span class="p">):</span> <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; _-:</span><span class="se">\n\r\t</span><span class="s1">&#39;</span><span class="p">))</span>

    <span class="kn">from</span> <span class="nn">neuropredict.io</span> <span class="k">import</span> <span class="n">process_pyradigm</span><span class="p">,</span> <span class="n">process_arff</span>

    <span class="n">method_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">outpath_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">missing_data_flag</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span> <span class="c1"># boolean flag for each dataset</span>

    <span class="k">for</span> <span class="n">mm</span><span class="p">,</span> <span class="n">cur_method</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">method_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cur_method</span> <span class="ow">in</span> <span class="p">[</span><span class="n">get_pyradigm</span><span class="p">]:</span>

            <span class="n">method_name</span><span class="p">,</span> <span class="n">out_path_cur_dataset</span> <span class="o">=</span> <span class="n">process_pyradigm</span><span class="p">(</span><span class="n">feature_path</span><span class="p">[</span><span class="n">mm</span><span class="p">],</span>
                                                                 <span class="n">subjects</span><span class="p">,</span> <span class="n">classes</span><span class="p">)</span>

            <span class="c1"># if feature_type in [&#39;pyradigm&#39;]:</span>
            <span class="c1">#     loaded_dataset = MLDataset(filepath=feature_path[mm])</span>
            <span class="c1"># else:</span>
            <span class="c1">#     raise ValueError(&#39;Invalid state of the program!&#39;)</span>
            <span class="c1">#</span>
            <span class="c1"># if len(loaded_dataset.description) &gt; 1:</span>
            <span class="c1">#     method_name = loaded_dataset.description</span>
            <span class="c1"># else:</span>
            <span class="c1">#     method_name = basename(feature_path[mm])</span>
            <span class="c1">#</span>
            <span class="c1"># method_names.append(clean_str(method_name))</span>
            <span class="c1"># if not saved_dataset_matches(loaded_dataset, subjects, classes):</span>
            <span class="c1">#     raise ValueError(</span>
            <span class="c1">#         &#39;supplied pyradigm dataset does not match samples in the meta data.&#39;)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     out_path_cur_dataset = feature_path[mm]</span>

        <span class="k">elif</span> <span class="n">cur_method</span> <span class="ow">in</span> <span class="p">[</span><span class="n">get_arff</span><span class="p">]:</span>

            <span class="n">method_name</span><span class="p">,</span> <span class="n">out_path_cur_dataset</span> <span class="o">=</span> <span class="n">process_arff</span><span class="p">(</span>
                    <span class="n">feature_path</span><span class="p">[</span><span class="n">mm</span><span class="p">],</span> <span class="n">subjects</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">)</span>

            <span class="c1"># loaded_dataset = MLDataset(arff_path=feature_path[mm])</span>
            <span class="c1"># if len(loaded_dataset.description) &gt; 1:</span>
            <span class="c1">#     method_name = loaded_dataset.description</span>
            <span class="c1"># else:</span>
            <span class="c1">#     method_name = basename(feature_path[mm])</span>
            <span class="c1">#</span>
            <span class="c1"># method_names.append(clean_str(method_name))</span>
            <span class="c1"># out_name = make_dataset_filename(method_name)</span>
            <span class="c1"># out_path_cur_dataset = pjoin(out_dir, out_name)</span>
            <span class="c1"># loaded_dataset.save(out_path_cur_dataset)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">cur_method</span> <span class="ow">in</span> <span class="p">[</span><span class="n">get_dir_of_dirs</span><span class="p">]:</span>
                <span class="n">method_name</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">feature_path</span><span class="p">[</span><span class="n">mm</span><span class="p">])</span>

            <span class="k">elif</span> <span class="n">cur_method</span> <span class="ow">in</span> <span class="p">[</span><span class="n">get_data_matrix</span><span class="p">]:</span>
                <span class="n">method_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">feature_path</span><span class="p">[</span><span class="n">mm</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">method_name</span> <span class="o">=</span> <span class="n">cur_method</span><span class="o">.</span><span class="vm">__name__</span>

            <span class="n">out_name</span> <span class="o">=</span> <span class="n">make_dataset_filename</span><span class="p">(</span><span class="n">method_name</span><span class="p">)</span>

            <span class="n">out_path_cur_dataset</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">out_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">saved_dataset_matches</span><span class="p">(</span><span class="n">out_path_cur_dataset</span><span class="p">,</span> <span class="n">subjects</span><span class="p">,</span> <span class="n">classes</span><span class="p">):</span>
                <span class="c1"># noinspection PyTypeChecker</span>
                <span class="n">out_path_cur_dataset</span> <span class="o">=</span> <span class="n">get_features</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span>
                                                    <span class="n">feature_path</span><span class="p">[</span><span class="n">mm</span><span class="p">],</span>
                                                    <span class="n">out_dir</span><span class="p">,</span> <span class="n">out_name</span><span class="p">,</span>
                                                    <span class="n">cur_method</span><span class="p">,</span> <span class="n">feature_type</span><span class="p">)</span>

        <span class="c1"># checking for presence of any missing data</span>
        <span class="n">data_mat</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">out_path_cur_dataset</span><span class="p">)</span><span class="o">.</span><span class="n">data_and_labels</span><span class="p">()</span>
        <span class="n">is_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_mat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_nan</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">data_missing_here</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">num_sub_with_md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">is_nan</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">num_var_with_md</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">is_nan</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user_impute_strategy</span> <span class="o">==</span> <span class="s1">&#39;raise&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MissingDataException</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1"> subjects with missing data found in </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1"> features</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">in </span><span class="si">{}</span><span class="s1"> dataset at </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Fill them and rerun, &#39;</span>
                    <span class="s1">&#39;or choose one of the available imputation strategies: </span><span class="si">{}</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_sub_with_md</span><span class="p">,</span> <span class="n">data_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                              <span class="n">num_var_with_md</span><span class="p">,</span> <span class="n">data_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                              <span class="n">method_name</span><span class="p">,</span> <span class="n">out_path_cur_dataset</span><span class="p">,</span>
                              <span class="n">cfg</span><span class="o">.</span><span class="n">avail_imputation_strategies</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_missing_here</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">method_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clean_str</span><span class="p">(</span><span class="n">method_name</span><span class="p">))</span>
        <span class="n">outpath_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_path_cur_dataset</span><span class="p">)</span>
        <span class="n">missing_data_flag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_missing_here</span><span class="p">)</span>

    <span class="c1"># finalizing the imputation strategy</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">missing_data_flag</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">One or more of the input datasets have missing data!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_impute_strategy</span> <span class="o">==</span> <span class="s1">&#39;raise&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MissingDataException</span><span class="p">(</span><span class="s1">&#39;Fill them and rerun, &#39;</span>
                                       <span class="s1">&#39;or choose one of the available &#39;</span>
                                       <span class="s1">&#39;imputation strategies: </span><span class="si">{}</span><span class="s1">&#39;</span>
                                       <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">avail_imputation_strategies</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">impute_strategy</span> <span class="o">=</span> <span class="n">user_impute_strategy</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The imputation strategy chosen is: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">impute_strategy</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># disabling the imputation altogether if there is no missing data</span>
        <span class="n">impute_strategy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">user_impute_strategy</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;raise&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ignoring imputation strategy chosen, as no missing data were found!&#39;</span><span class="p">)</span>

    <span class="n">combined_name</span> <span class="o">=</span> <span class="n">uniq_combined_name</span><span class="p">(</span><span class="n">method_names</span><span class="p">)</span>

    <span class="c1"># checking if there are any duplicates</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">outpath_list</span><span class="p">))</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">outpath_list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Duplicate paths to input dataset found!</span><span class="se">\n</span><span class="s1">&#39;</span>
                           <span class="s1">&#39;Try distinguish inputs further. Otherwise report this bug &#39;</span>
                           <span class="s1">&#39;@ github.com/raamana/neuropredict/issues/new&#39;</span><span class="p">)</span>

    <span class="n">dataset_paths_file</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;datasetlist.&#39;</span> <span class="o">+</span> <span class="n">combined_name</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dataset_paths_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dpf</span><span class="p">:</span>
        <span class="n">dpf</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outpath_list</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Data import is done.</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">method_names</span><span class="p">,</span> <span class="n">dataset_paths_file</span><span class="p">,</span> <span class="n">missing_data_flag</span><span class="p">,</span> <span class="n">impute_strategy</span>



<span class="k">def</span> <span class="nf">make_method_list</span><span class="p">(</span><span class="n">fs_subject_dir</span><span class="p">,</span> <span class="n">user_feature_paths</span><span class="p">,</span> <span class="n">user_feature_type</span><span class="o">=</span><span class="s1">&#39;dir_of_dirs&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an organized list of feature paths and methods to read in features.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fs_subject_dir : str</span>
<span class="sd">    user_feature_paths : list of str</span>
<span class="sd">    user_feature_type : str</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    feature_dir : list</span>
<span class="sd">    method_list : list</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">freesurfer_readers</span> <span class="o">=</span> <span class="p">[</span><span class="n">aseg_stats_subcortical</span><span class="p">,</span> <span class="n">aseg_stats_whole_brain</span><span class="p">]</span>
    <span class="n">userdefined_readers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dir_of_dirs&#39;</span><span class="p">:</span> <span class="n">get_dir_of_dirs</span><span class="p">,</span>
                           <span class="s1">&#39;data_matrix&#39;</span><span class="p">:</span> <span class="n">get_data_matrix</span><span class="p">,</span>
                           <span class="s1">&#39;pyradigm&#39;</span><span class="p">:</span> <span class="n">get_pyradigm</span><span class="p">,</span>
                           <span class="s1">&#39;arff&#39;</span><span class="p">:</span> <span class="n">get_arff</span><span class="p">}</span>

    <span class="n">feature_dir</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">method_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">not_unspecified</span><span class="p">(</span><span class="n">user_feature_paths</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">user_feature_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">userdefined_readers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Invalid feature type or &quot;</span>
                                      <span class="s2">&quot;its reader is not implemented yet!&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">upath</span> <span class="ow">in</span> <span class="n">user_feature_paths</span><span class="p">:</span>
            <span class="n">feature_dir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">upath</span><span class="p">)</span>
            <span class="n">method_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">userdefined_readers</span><span class="p">[</span><span class="n">user_feature_type</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">not_unspecified</span><span class="p">(</span><span class="n">fs_subject_dir</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fsrdr</span> <span class="ow">in</span> <span class="n">freesurfer_readers</span><span class="p">:</span>
            <span class="n">feature_dir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fs_subject_dir</span><span class="p">)</span>
            <span class="n">method_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fsrdr</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">method_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_dir</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid specification for features!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">method_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Atleast one feature set must be specified.&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Requested features for analysis:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">mm</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">method_list</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">feature_dir</span><span class="p">[</span><span class="n">mm</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">feature_dir</span><span class="p">,</span> <span class="n">method_list</span>


<span class="k">def</span> <span class="nf">prepare_and_run</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">options_path</span><span class="p">,</span>
                    <span class="n">user_feature_paths</span><span class="p">,</span> <span class="n">user_feature_type</span><span class="p">,</span> <span class="n">fs_subject_dir</span><span class="p">,</span>
                    <span class="n">train_perc</span><span class="p">,</span> <span class="n">num_rep_cv</span><span class="p">,</span> <span class="n">positive_class</span><span class="p">,</span>
                    <span class="n">sub_group_list</span><span class="p">,</span> <span class="n">feature_selection_size</span><span class="p">,</span>
                    <span class="n">user_impute_strategy</span><span class="p">,</span> <span class="n">num_procs</span><span class="p">,</span>
                    <span class="n">grid_search_level</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">feat_select_method</span><span class="p">):</span>
    <span class="s2">&quot;Organizes the inputs and prepares them for CV&quot;</span>

    <span class="n">feature_dir</span><span class="p">,</span> <span class="n">method_list</span> <span class="o">=</span> <span class="n">make_method_list</span><span class="p">(</span><span class="n">fs_subject_dir</span><span class="p">,</span> <span class="n">user_feature_paths</span><span class="p">,</span>
                                                <span class="n">user_feature_type</span><span class="p">)</span>

    <span class="n">method_names</span><span class="p">,</span> <span class="n">dataset_paths_file</span><span class="p">,</span> <span class="n">missing_flag</span><span class="p">,</span> <span class="n">impute_strategy</span> \
        <span class="o">=</span> <span class="n">import_datasets</span><span class="p">(</span><span class="n">method_list</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">subjects</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span>
                          <span class="n">feature_dir</span><span class="p">,</span> <span class="n">user_feature_type</span><span class="p">,</span> <span class="n">user_impute_strategy</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Requested processing for the following subgroups:&#39;</span>
          <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="k">for</span> <span class="n">sg</span> <span class="ow">in</span> <span class="n">sub_group_list</span><span class="p">])))</span>

    <span class="c1"># iterating through the given set of subgroups</span>
    <span class="n">num_sg</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_group_list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sgi</span><span class="p">,</span> <span class="n">sub_group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sub_group_list</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">Processing subgroup : </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">)&#39;</span>
              <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub_group</span><span class="p">),</span> <span class="n">sgi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_sg</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span><span class="p">))</span>
        <span class="n">out_dir_sg</span> <span class="o">=</span> <span class="n">pjoin</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">sub_group_identifier</span><span class="p">(</span><span class="n">sub_group</span><span class="p">,</span> <span class="n">sg_index</span><span class="o">=</span><span class="n">sgi</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">results_file_path</span> <span class="o">=</span> <span class="n">rhst</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">dataset_paths_file</span><span class="p">,</span> <span class="n">method_names</span><span class="p">,</span> <span class="n">out_dir_sg</span><span class="p">,</span>
                                     <span class="n">train_perc</span><span class="o">=</span><span class="n">train_perc</span><span class="p">,</span>
                                     <span class="n">num_repetitions</span><span class="o">=</span><span class="n">num_rep_cv</span><span class="p">,</span>
                                     <span class="n">positive_class</span><span class="o">=</span><span class="n">positive_class</span><span class="p">,</span>
                                     <span class="n">sub_group</span><span class="o">=</span><span class="n">sub_group</span><span class="p">,</span>
                                     <span class="n">feat_sel_size</span><span class="o">=</span><span class="n">feature_selection_size</span><span class="p">,</span>
                                     <span class="n">impute_strategy</span><span class="o">=</span><span class="n">impute_strategy</span><span class="p">,</span>
                                     <span class="n">missing_flag</span><span class="o">=</span><span class="n">missing_flag</span><span class="p">,</span>
                                     <span class="n">num_procs</span><span class="o">=</span><span class="n">num_procs</span><span class="p">,</span>
                                     <span class="n">grid_search_level</span><span class="o">=</span><span class="n">grid_search_level</span><span class="p">,</span>
                                     <span class="n">classifier_name</span><span class="o">=</span><span class="n">classifier</span><span class="p">,</span>
                                     <span class="n">feat_select_method</span><span class="o">=</span><span class="n">feat_select_method</span><span class="p">,</span>
                                     <span class="n">options_path</span><span class="o">=</span><span class="n">options_path</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Saving the visualizations to </span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_dir</span><span class="p">))</span>
        <span class="n">make_visualizations</span><span class="p">(</span><span class="n">results_file_path</span><span class="p">,</span> <span class="n">out_dir_sg</span><span class="p">,</span> <span class="n">options_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span>


<div class="viewcode-block" id="cli"><a class="viewcode-back" href="../API.html#run_workflow.cli">[docs]</a><span class="k">def</span> <span class="nf">cli</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main entry point.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">subjects</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">options_path</span><span class="p">,</span> <span class="n">user_feature_paths</span><span class="p">,</span> <span class="n">user_feature_type</span><span class="p">,</span> \
        <span class="n">fs_subject_dir</span><span class="p">,</span> <span class="n">train_perc</span><span class="p">,</span> <span class="n">num_rep_cv</span><span class="p">,</span> <span class="n">positive_class</span><span class="p">,</span> <span class="n">sub_group_list</span><span class="p">,</span> \
        <span class="n">feature_selection_size</span><span class="p">,</span> <span class="n">impute_strategy</span><span class="p">,</span> <span class="n">num_procs</span><span class="p">,</span> \
        <span class="n">grid_search_level</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">feat_select_method</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running neuropredict version </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__version__</span><span class="p">))</span>
    <span class="n">prepare_and_run</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">options_path</span><span class="p">,</span>
                    <span class="n">user_feature_paths</span><span class="p">,</span> <span class="n">user_feature_type</span><span class="p">,</span> <span class="n">fs_subject_dir</span><span class="p">,</span>
                    <span class="n">train_perc</span><span class="p">,</span> <span class="n">num_rep_cv</span><span class="p">,</span> <span class="n">positive_class</span><span class="p">,</span>
                    <span class="n">sub_group_list</span><span class="p">,</span> <span class="n">feature_selection_size</span><span class="p">,</span> <span class="n">impute_strategy</span><span class="p">,</span> <span class="n">num_procs</span><span class="p">,</span>
                    <span class="n">grid_search_level</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> <span class="n">feat_select_method</span><span class="p">)</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="run"><a class="viewcode-back" href="../API.html#run_workflow.run">[docs]</a><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">feature_sets</span><span class="p">,</span>
        <span class="n">feature_type</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">default_feature_type</span><span class="p">,</span>
        <span class="n">meta_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pipeline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">train_perc</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">num_repetitions</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
        <span class="n">positive_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">feat_sel_size</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">default_num_features_to_select</span><span class="p">,</span>
        <span class="n">sub_groups</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
        <span class="n">grid_search_level</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">GRIDSEARCH_LEVEL_DEFAULT</span><span class="p">,</span>
        <span class="n">num_procs</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate comprehensive report on the predictive performance</span>
<span class="sd">    for different feature sets and statistically compare them.</span>

<span class="sd">    Main entry point for API access.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    feature_sets : list</span>
<span class="sd">        The input can be specified in either of the following ways:</span>
<span class="sd">            - list of paths to pyradigm datasets saved on disk</span>
<span class="sd">            - path to a file containing list of paths</span>
<span class="sd">                (each line containing path to a valid MLDataset)</span>
<span class="sd">            - list of MLDatasets that are already loaded</span>
<span class="sd">            - list of tuples (to specify multiple features),</span>
<span class="sd">                each element containing (X, y) i.e. data and target labels</span>
<span class="sd">            - a single tuple containing (X, y) i.e. data and target labels</span>
<span class="sd">            - list of paths to CSV files, each containing one type of features.</span>

<span class="sd">            When specifying multiple sets of input features, ensure:</span>
<span class="sd">            - all of them contain the same number of samples</span>
<span class="sd">            - each sample belongs to same class across all feature sets.</span>

<span class="sd">    feature_type : str</span>
<span class="sd">        String identifying the type of features as described above. It could be:</span>
<span class="sd">        &#39;list_of_pyradigm_paths&#39;, &#39;pyradigm_list&#39;,</span>
<span class="sd">        &#39;list_of_tuples&#39;, &#39;tuple&#39;, &#39;list_of_csv_paths&#39;</span>

<span class="sd">    meta_data : multiple</span>
<span class="sd">        The meta data can be specified in either of the following ways:</span>

<span class="sd">            - a path to a meta data file (see :doc:`features` page)</span>
<span class="sd">            - a dict keyed in by sample IDs with values representing their classes.</span>
<span class="sd">            - None, if meta data is already specified in ``feature_sets`` input</span>
<span class="sd">                e.g. with pyradigms</span>

<span class="sd">    pipeline : str or object</span>
<span class="sd">        If a string, it identifying one of the implemented classifiers</span>
<span class="sd">        e.g. &#39;RandomForestClassifier&#39; or &#39;ExtraTreesClassifier&#39;</span>
<span class="sd">        If an object, it must be a sciki-learn pipeline describing the sequence of</span>
<span class="sd">        steps.</span>
<span class="sd">        This is typically a set of feature selections or dim. reduction steps</span>
<span class="sd">        followed by an estimator (classifier).</span>

<span class="sd">        See http://scikit-learn.org/stable/modules/pipeline.html#pipeline for more</span>
<span class="sd">        details.</span>

<span class="sd">        Default: None, which leads to the selection of a Random Forest classifier,</span>
<span class="sd">         with robust scaling, followed by removal of low variance features.</span>

<span class="sd">    method_names : list</span>
<span class="sd">        A list of names to denote the different feature sets</span>

<span class="sd">    out_results_dir : str</span>
<span class="sd">        Path to output directory to save the cross validation results to.</span>
<span class="sd">        If not specified, a new directory named &#39;neuropredict&#39; will be created</span>
<span class="sd">        in the current directory.</span>

<span class="sd">    train_perc : float, optional</span>
<span class="sd">        Percetange of subjects to train the classifier on.</span>
<span class="sd">        The percentage is applied to the size of the smallest class to estimate</span>
<span class="sd">        the number of subjects from each class to be reserved for training.</span>
<span class="sd">        The smallest class is chosen to avoid class-imbalance in the training set.</span>
<span class="sd">        Default: 0.8 (80%).</span>

<span class="sd">    positive_class : str</span>
<span class="sd">        Name of the class to be treated as positive in calculation of AUC</span>

<span class="sd">    feat_sel_size : str or int</span>
<span class="sd">        Number of features to select as part of feature selection. Options:</span>

<span class="sd">             - &#39;tenth&#39;</span>
<span class="sd">             - &#39;sqrt&#39;</span>
<span class="sd">             - &#39;log2&#39;</span>
<span class="sd">             - &#39;all&#39;</span>

<span class="sd">            Default: \&#39;tenth\&#39; of the number of samples in the training set. For</span>
<span class="sd">            example, if your dataset has 90 samples, you chose 50 percent for</span>
<span class="sd">            training (default),  then Y will have 90*.5=45 samples in training</span>
<span class="sd">            set, leading to 5 features to be selected for taining. If you choose a</span>
<span class="sd">            fixed integer, ensure all the feature sets under evaluation have</span>
<span class="sd">            atleast that many features.</span>

<span class="sd">    num_repetitions : int, optional</span>
<span class="sd">        Number of repetitions of cross-validation estimation. Default: 200.</span>

<span class="sd">    num_procs : int, optional</span>
<span class="sd">        Number of CPUs to use to parallelize CV repetitions.</span>

<span class="sd">        Default : 4. Number of CPUs will be capped at the number available on the</span>
<span class="sd">        machine if higher is requested.</span>

<span class="sd">    sub_groups : list</span>
<span class="sd">        This option allows the user to study different combinations of classes in</span>
<span class="sd">        a multi-class (N&gt;2) dataset. For example, in a dataset with 3 classes CN,</span>
<span class="sd">        FTD and AD, two studies of pair-wise combinations can be studied</span>
<span class="sd">        separately with the following flag ``--sub_groups CN,FTD CN,AD``. This</span>
<span class="sd">        allows the user to focus on few interesting subgroups depending on their</span>
<span class="sd">        dataset/goal.</span>

<span class="sd">        Format: Different subgroups must be separated by space, and each sub-group</span>
<span class="sd">        must be a comma-separated list of class names defined in the meta data</span>
<span class="sd">        file. Hence it is strongly recommended to use class names without any</span>
<span class="sd">        spaces, commas, hyphens and special characters, and ideally just</span>
<span class="sd">        alphanumeric characters separated by underscores. Any number of subgroups</span>
<span class="sd">        can be specified, but each subgroup must have atleast two distinct classes.</span>

<span class="sd">        Default: ``&#39;all&#39;``, leading to inclusion of all available classes in a</span>
<span class="sd">        all-vs-all multi-class setting.</span>

<span class="sd">    grid_search_level : str</span>
<span class="sd">        Flag to specify the level of grid search during hyper-parameter</span>
<span class="sd">        optimization on the training set.</span>
<span class="sd">        Allowed options are : &#39;none&#39;, &#39;light&#39; and &#39;exhaustive&#39;, in the order of</span>
<span class="sd">        how many values/values will be optimized.</span>

<span class="sd">        More parameters and more values demand more resources and much longer time</span>
<span class="sd">        for optimization.</span>

<span class="sd">        The &#39;light&#39; option tries to use &quot;folk wisdom&quot; to try least number of</span>
<span class="sd">        values (no more than one or two), for the parameters for the given</span>
<span class="sd">        classifier e.g. a lage number say 500 trees for a random forest</span>
<span class="sd">        optimization. The &#39;light&#39; option will be the fastest and should give a</span>
<span class="sd">        &quot;rough idea&quot; of predictive performance. The &#39;exhaustive&#39; option will try</span>
<span class="sd">        to most parameter values for the most parameters that can be optimized.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    results_path : str</span>
<span class="sd">        Path to pickle file containing full set of CV results.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">return</span></div>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">cli</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Pradeep Reddy Raamana.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.1.2.
    </div>
  </body>
</html>